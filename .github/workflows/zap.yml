name: OWASP ZAP Scan

on: [push]

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker
      run: docker version

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Read latest version tag
      id: read_version
      run: echo "VERSION=$(cat version_counter.txt)" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create zap-network

    - name: Build and run Docker application
      run: |
        docker pull aodiploma/chilla:v${{ env.VERSION }}
        docker build -t my-app:latest .
        docker run -d --network zap-network --name my-app -p 8088:8088 my-app:latest

    - name: Run OWASP ZAP as daemon
      run: |
        docker run -d --name zap --network zap-network -v $(pwd):/zap/wrk/:rw -u root zaproxy/zap-stable \
          zap.sh -daemon -host 0.0.0.0 -port 8089
        sleep 30  # Дати ZAP час на запуск

    - name: Check if ZAP API is available
      run: |
        until curl -s http://localhost:8089/OTHER/core/other/json/version/; do
          echo "Waiting for ZAP to be available..."
          sleep 5
        done

    - name: Start ZAP Spider Scan
      run: |
        curl "http://localhost:8089/JSON/spider/action/scan/?url=http://my-app:8088&maxChildren=10"
        sleep 20  # Чекаємо завершення Spider Scan

    - name: Start ZAP Active Scan
      run: |
        curl "http://localhost:8089/JSON/ascan/action/scan/?url=http://my-app:8088"
        sleep 60  # Дати час на Active Scan

    - name: Generate ZAP report
      run: |
        curl "http://localhost:8089/OTHER/core/other/htmlreport/" -o report.html

    - name: Upload ZAP report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report.html
